<html><head><title>ScalaPB: Sealed oneofs</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Nadav Samet" /><meta name="description" content="Protocol buffer compiler for Scala" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="ScalaPB: Sealed oneofs" /><meta name="title" property="og:title" content="ScalaPB: Sealed oneofs" /><meta name="og:site_name" content="ScalaPB" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Protocol buffer compiler for Scala" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="ScalaPB: Sealed oneofs" /><meta name="twitter:image" content="/img/poster.png" /><meta name="twitter:description" content="Protocol buffer compiler for Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><link rel="stylesheet" href="/css/custom.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>ScalaPB</span></div></a></li> <li><a href="/" class="">About</a></li> <li><a href="/sbt-settings.html" class="">SBT Settings</a></li> <li><a href="/generated-code.html" class="">Generated Code</a></li> <li><a href="/customizations.html" class="">Customizations</a></li> <li><a href="/sealed-oneofs.html" class=" active ">Sealed oneofs</a></li> <li><a href="/user_defined_options.html" class="">User-defined Options</a></li> <li><a href="/grpc.html" class="">gRPC</a></li> <li><a href="/scala.js.html" class="">Scala.js</a></li> <li><a href="/sparksql.html" class="">SparkSQL</a></li> <li><a href="/json.html" class="">JSON</a></li> <li><a href="/scalapbc.html" class="">ScalaPBC</a></li> <li><a href="/api/scalapb/latest/" class="">API Docs</a></li> <li><a href="/faq.html" class="">FAQ</a></li> <li><a href="/migrating.html" class="">Migrating</a></li> <li><a href="/contact.html" class="">Contact Us</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/scalapb/ScalaPB"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/scalapb/ScalaPB"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('ScalaPB Protocol buffer compiler for Scala');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('ScalaPB Protocol buffer compiler for Scala');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="scalapb" data-github-repo="ScalaPB"><div class="content-wrapper"><section><h1 id="sealed-oneofs">Sealed oneofs</h1>

<p>**Note: sealed oneofs are available only in ScalaPB 0.8 or later. The API and rules are considered experimental. See note at the bottom. **</p>

<p>Sealed oneofs are a subset of oneofs for which ScalaPB generates idiomatic data types for.</p>

<h1 id="example">Example</h1>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Expr</span> <span class="p">{</span>
    <span class="k">oneof</span> <span class="n">sealed_value</span> <span class="p">{</span>
        <span class="n">Literal</span> <span class="na">lit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">Add</span> <span class="na">add</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">Mul</span> <span class="na">mul</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Literal</span> <span class="p">{</span>
    <span class="kt">int32</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Add</span> <span class="p">{</span>
    <span class="n">Expr</span> <span class="na">left</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">Expr</span> <span class="na">right</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Mul</span> <span class="p">{</span>
    <span class="n">Expr</span> <span class="na">left</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">Expr</span> <span class="na">right</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Program</span> <span class="p">{</span>
    <span class="k">repeated</span> <span class="n">Expr</span> <span class="na">exprs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Note that the name of the oneof name is <code class="highlighter-rouge">sealed_value</code>. This is what makes ScalaPB treat <code class="highlighter-rouge">Expr</code> as a sealed oneof and generate code similar to the following:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Expr</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">isEmpty</span><span class="k">:</span> <span class="kt">Boolean</span>
    <span class="k">def</span> <span class="n">isDefined</span><span class="k">:</span> <span class="kt">Boolean</span>
    <span class="k">def</span> <span class="n">asMessage</span><span class="k">:</span> <span class="kt">ExprMessage</span>  <span class="c1">// converts to the standard representation
</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">Expr</span> <span class="o">{</span>
    <span class="k">case</span> <span class="k">object</span> <span class="nc">Empty</span> <span class="k">extends</span> <span class="nc">Expr</span>
<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Literal</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Expr</span> <span class="k">with</span> <span class="nc">GeneratedMessage</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Add</span><span class="o">(</span><span class="n">left</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">,</span> <span class="n">right</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Expr</span> <span class="k">with</span> <span class="nc">GeneratedMessage</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Mul</span><span class="o">(</span><span class="n">left</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">,</span> <span class="n">right</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Expr</span> <span class="k">with</span> <span class="nc">GeneratedMessage</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Programs</span><span class="o">(</span><span class="n">exprs</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Expr</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">GeneratedMessage</span>

<span class="c1">// Standard case class for the Expr message, containing the
// default style of the code that gets generated for oneofs.
</span><span class="k">case</span> <span class="k">class</span> <span class="nc">ExprMessage</span><span class="o">(</span><span class="n">sealedValue</span><span class="k">:</span> <span class="kt">ExprMessage.SealedValue</span><span class="o">)</span>
</code></pre>
</div>

<p>The above Scala representation of the protocol buffer is much nicer to work with than the default oneof representation, as there are no wrapper types around each individual case of the oneof. Also note that optional fields of type <code class="highlighter-rouge">Expr</code> are not boxed inside an <code class="highlighter-rouge">Option</code> since we have <code class="highlighter-rouge">Expr.Empty</code> that represents the empty case.</p>

<h1 id="sealed-oneof-rules">Sealed oneof rules</h1>

<p>A sealed oneof is detected when a message (denoted below as the <em>containing message</em>) contains a oneof named <code class="highlighter-rouge">sealed_value</code>. The code generator checks the following rules for each sealed oneof. If any of these rules fail, then the code generator aborts.</p>

<ol>
  <li>
    <p>The oneof named <code class="highlighter-rouge">sealed_value</code> must be the only oneof in the containing message.</p>
  </li>
  <li>
    <p>No additional fields (except those inside <code class="highlighter-rouge">sealed_values</code>) may be defined inside the containing message.</p>
  </li>
  <li>
    <p>No nested messages or enums are allowed to be defined in the containing message.</p>
  </li>
  <li>
    <p>The containing message must be a top-level message.</p>
  </li>
  <li>
    <p>All the oneof cases must be distinct top-level messsage types that are defined in the same file as the sealed oneof.</p>
  </li>
  <li>
    <p>A message type can appear in at most one sealed oneof.</p>
  </li>
</ol>

<h1 id="experimental-status">Experimental Status</h1>

<p>Some of the rules above are inherently required (for example, that the message types need to be distinct). Other rules, such as the one requesting that all involved messages need to be top-level, were added to make the implementation simpler. That particular rule helps ensuring that all the cases can be generated into a single Scala source file without changing too much the existing way the code generator works. It is possible that some of the rules will change over time, though most likely they are only going to become less restrictive so existing code does not break.</p>

<p>Currently, sealed oneofs are implemented as a custom type defined over the old-style container message. This implementation detail is exposed through <code class="highlighter-rouge">asMessage</code> which returns the underlying message representing the sealed oneof.  It is possible that in a future version, sealed oneofs would have a direct implementation, and therefore <code class="highlighter-rouge">asMesssage</code> and its return type should be considered an experimental API.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/protobuf.min.js"></script><script>hljs.configure({languages:['scala','java','bash','protobuf']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'trueaccord/ScalaPB'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>