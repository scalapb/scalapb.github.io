<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ScalaPB Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ScalaPB Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-346180-20","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Writing protoc plugins in Scala | ScalaPB</title><meta data-react-helmet="true" property="og:image" content="https://scalapb.github.io/img/scalapb-social-light.png"><meta data-react-helmet="true" name="twitter:image" content="https://scalapb.github.io/img/scalapb-social-light.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for ScalaPB"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Writing protoc plugins in Scala | ScalaPB"><meta data-react-helmet="true" name="description" content="This guide will show you how to write Protoc Plugins in Scala so you can write your own custom code generators for protocol buffers."><meta data-react-helmet="true" property="og:description" content="This guide will show you how to write Protoc Plugins in Scala so you can write your own custom code generators for protocol buffers."><meta data-react-helmet="true" property="og:url" content="https://scalapb.github.io//docs/writing-plugins"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://scalapb.github.io//docs/writing-plugins"><link rel="stylesheet" href="/styles.0bbc50d2.css">
<link rel="preload" href="/styles.022ff8f0.js" as="script">
<link rel="preload" href="/runtime~main.0526e393.js" as="script">
<link rel="preload" href="/main.61b71543.js" as="script">
<link rel="preload" href="/1.d1f2961e.js" as="script">
<link rel="preload" href="/2.f4df6e70.js" as="script">
<link rel="preload" href="/49.50d7d611.js" as="script">
<link rel="preload" href="/50.a4265ab1.js" as="script">
<link rel="preload" href="/935f2afb.5b2cd0a8.js" as="script">
<link rel="preload" href="/17896441.4580ba69.js" as="script">
<link rel="preload" href="/30c1f25e.81796517.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/ScalaPB.png" alt="ScalaPB" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/ScalaPB.png" alt="ScalaPB" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/scalapb/ScalaPB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/ScalaPB.png" alt="ScalaPB" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/ScalaPB.png" alt="ScalaPB" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/scalapb/ScalaPB" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLinkText_yu3-">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Tutorial</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_yu3-">Customizing</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/customizations">Customizations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sbt-settings">SBT Settings</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/transformations">Transformations</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_yu3-">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generated-code">Generated Code</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sealed-oneofs">Sealed oneofs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/user_defined_options">User-defined options</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/grpc">gRPC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/scala.js">Scala.js</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sparksql">SparkSQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/json">JSON</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/scalapbc">ScalaPBC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/dotty">Dotty</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/third-party-protos">Using third-party protos</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/common-protos">Common protos</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/validation">Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generic">Generic programming</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/writing-plugins">Writing protoc plugins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrading">Upgrading</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_yu3-">Getting Help</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contact">Contacting us</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Writing protoc plugins in Scala</h1></header><div class="markdown"><p>This guide will show you how to write Protoc Plugins in Scala so you can write your own custom code generators for protocol buffers.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="introduction-what-is-a-protoc-plugin"></a>Introduction: What is a protoc plugin?<a class="hash-link" href="#introduction-what-is-a-protoc-plugin" title="Direct link to heading">#</a></h2><p>A protoc plugin is a program that gets invoked by protoc (the protobuf compiler) and generates output files based on a set of input protocol buffers. The plugins are programs that read a <code>CodeGeneratorRequest</code> via their standard input and write a <code>CodeGeneratorResponse</code> to their standard output.</p><p><code>CodeGeneratorRequest</code> is a protobuf that describes the protocol buffers being compiled, along with all their transitive imports. <code>CodeGeneratorResponse</code> is a protobuf that contains a list of output filenames along with their content to be written to the file system by protoc. See <a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/compiler/plugin.proto" target="_blank" rel="noopener noreferrer">plugin.proto</a> for the definitions of these messages.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="when-to-write-a-protoc-plugin"></a>When to write a protoc plugin?<a class="hash-link" href="#when-to-write-a-protoc-plugin" title="Direct link to heading">#</a></h2><p>Generally, write a protoc plugin whenever you want to generate code that corresponds to the structure of protobufs. For example, ScalaPB‚Äôs code protoc plugin generates case classes for each protobuf message. The protoc plugins shipped with <a href="https://doc.akka.io/docs/akka-grpc/current/" target="_blank" rel="noopener noreferrer">akka-grpc</a>, <a href="https://pekko.apache.org/docs/pekko-grpc/current/" target="_blank" rel="noopener noreferrer">pekko-grpc</a>, <a href="https://github.com/typelevel/fs2-grpc" target="_blank" rel="noopener noreferrer">fs2-grpc</a> and <a href="https://scalapb.github.io/zio-grpc/" target="_blank" rel="noopener noreferrer">zio-grpc</a> generate Scala traits with methods that correspond to protobuf service methods.</p><p>Plugins can also be used to generate code that validates messages (see  <a href="https://github.com/scalapb/scalapb-validate" target="_blank" rel="noopener noreferrer">scalapb-validate</a>), or convert protobufs to a different format.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Some use cases don‚Äôt require a plugin.</h5></div><div class="admonition-content"><p>Using Descriptors you can inspect the structure of protocol buffers at runtime, extract values of arbitrary fields from message instances and even create new instances of messages. You can look into the source of <a href="https://github.com/scalapb/scalapb-json4s/blob/master/src/main/scala/scalapb/json4s/JsonFormat.scala" target="_blank" rel="noopener noreferrer">scalapb-json4s</a> to see how conversion to and from JSON can be done without code generation. In contrast, the RPC libraries mentioned above create traits with methods that correspond to methods in the proto which would be impossible to accomplish at runtime (at least, in a statically typed manner).</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="getting-started"></a>Getting Started<a class="hash-link" href="#getting-started" title="Direct link to heading">#</a></h2><p>As plugins are just programs that read a <code>CodeGeneratorRequest</code> and write a <code>CodeGeneratorResponse</code>, they are fairly simple to code. However, as you start going, you will want:</p><ul><li><strong>Rapidly test changes</strong> in the generator over a sample protobuf, so you don&#x27;t have to manually publish the plugin each time you want to try the generated code.</li><li><strong>Access ScalaPB&#x27;s <code>DescriptorImplicits</code></strong> which give you access to the Scala types and names used by ScalaPB for the different protobuf entities. So your code doesn‚Äôt have to guess.</li><li><strong>Publish your plugin</strong> in different formats for users of SBT and for users of other build tools (CLI, maven, etc)</li></ul><p>To let you do all of the above, and to get you off to a great start with a streamlined development setup that uses the current best practices, we have prepared a project template. To create your plugin:</p><ol><li><p>Open a terminal and change to your development directory. The project will be generated into a subdirectory of this directory.</p></li><li><p>Create your project:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">sbt new scalapb/protoc-gen-template.g8</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>The template will prompt you for the name of your plugin and what package name to use. The answers for those questions will be used extensively in the generated project.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="look-around"></a>Look around<a class="hash-link" href="#look-around" title="Direct link to heading">#</a></h2><p>The project that is generated is an sbt multiproject with the following directory structure:</p><ul><li><code>code-gen</code>: the actual code generator.</li><li><code>core</code>: is an optional Scala library that the generated code can depend on. For example, if you find that the generator code is producing a large block of code, you might want to move it to this library, and call it from there.</li><li><code>e2e</code>: an integration test for your plugin. The <code>e2e</code> project contains a test protobuf in <code>src/main/protobuf</code>, and you should add some more based on what needs to be tested for your plugin. The project also has an munit test suite to exercise the generated code. Each time you run the tests, the code generator will be recompiled, and code for the protobufs will be regenerated and compiled. This flow results in very productive edit-test iterations.</li></ul><p>Now, start <code>sbt</code> and type <code>projects</code>. You will something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">[info] In file:/tmp/my-cool-plugin/</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     codeGenJVM2_12</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     codeGenJVM2_13</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     coreJVM2_12</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     coreJVM2_13</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     e2eJVM2_12</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     e2eJVM2_13</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     protoc-gen-my-cool-plugin</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     protoc-gen-my-cool-plugin-unix</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]     protoc-gen-my-cool-plugin-windows</span></div><div class="token-line" style="color:#403f53"><span class="token plain">[info]   * root</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>You might wonder why we have different synthetic sub-projects for different versions of Scala. We are using <a href="https://github.com/sbt/sbt-projectmatrix" target="_blank" rel="noopener noreferrer">sbt-projectmatrix</a> here, instead of SBT‚Äôs built-in cross-version support to facilitate the use of the code generator by e2e. The root cause is that SBT itself is built in Scala 2.12.  When you run the e2e tests for Scala 2.13, we want to be able to compile and execute the Scala 2.12 version of the code generator so it can load quickly into the same JVM used by SBT. This is not currently possible with SBT <code>crossScalaVersions</code>.</p></div></div><p>The <code>protoc-gen-*</code> projects are used for publishing artifcats and will be described in a later section.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="running-the-tests"></a>Running the tests<a class="hash-link" href="#running-the-tests" title="Direct link to heading">#</a></h2><p>To run the end-to-end tests for Scala 2.12 and Scala 2.13, inside SBT type:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">e2eJVM2_12/test</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">e2eJVM2_13/test</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This will compile the code generator (for Scala 2.12 in both cases), generate the code for the protos in <code>e2e/src/main/protobuf</code>, compile and run the tests in e2e for the corresponding Scala version.</p><p>Now, find the generated code under <code>e2e/target/jvm-2.12/src_managed/main/scalapb/com/myplugin/test/TestMessageFieldNums.scala</code>. The path might differ based on the package name you chose when creating the project.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="understanding-the-code-generator"></a>Understanding the code generator<a class="hash-link" href="#understanding-the-code-generator" title="Direct link to heading">#</a></h2><p>Look for <code>CodeGenerator.scala</code> under the code-gen directory. There you will find an object like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">object CodeGenerator extends CodeGenApp {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  override def registerExtensions(registry: ExtensionRegistry): Unit = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    Scalapb.registerAllExtensions(registry)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  // When your code generator will be invoked from SBT via sbt-protoc,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  // this will add the following artifact to your users build whenver</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  // the generator is used in `PB.targets`:</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  override def suggestedDependencies: Seq[Artifact] =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    Seq(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      Artifact(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        BuildInfo.organization,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        &quot;my-cool-plugin-core&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        BuildInfo.version,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        crossVersion = true</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      )</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    )</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  // This is called by CodeGenApp after the request is parsed.</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def process(request: CodeGenRequest): CodeGenResponse =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ProtobufGenerator.parseParameters(request.parameter) match {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      case Right(params) =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        // Implicits gives you extension methods that provide ScalaPB</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        // names and types for protobuf entities.</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        val implicits =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          DescriptorImplicits.fromCodeGenRequest(params, request)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        // Process each top-level message in each file.</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        // This can be customized if you want to traverse</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        // the input in a different way.</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        CodeGenResponse.succeed(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            file &lt;- request.filesToGenerate</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            message &lt;- file.getMessageTypes().asScala</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          } yield new MessagePrinter(message, implicits).result</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        )</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      case Left(error)   =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        CodeGenResponse.fail(error)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The object extends the <code>CodeGenApp</code> trait. This trait provides our application a <code>main</code> method so it can be used as a standalone protoc plugin. That trait extends another trait named <code>ProtocCodeGenerator</code> which facilitates the integration with <code>sbt-protoc</code>. <code>ProtocCodeGenerator</code> provides for us the method <code>suggestedDependencies</code> that let us specify which libraries we want to append to the <code>libraryDependencies</code> of our users. Normally, we want to add our <code>core</code> library. If you don&#x27;t need to change the user&#x27;s library dependencies you can remove this method as the default implementations return an empty list of artifacts.</p><p>The <code>registerExtensions</code> method is called when parsing the request and used to install protobuf extensions inside an <code>ExtensionRegistry</code>. This is useful if you are planning to add <a href="/docs/user_defined_options">custom protobuf options</a>. See the section &quot;Adding custom options&quot; below to learn how to add custom options to your generator.</p><p>The main action happens at the <code>process</code> method that takes a <code>CodeGenRequest</code> and returns a <code>CodeGenResponse</code>. These classes are simple wrappers around  the Java based protobufs <code>CodeGeneratorRequest</code> and <code>CodeGeneratorResponse</code> and are provided by a helper project called <a href="https://github.com/scalapb/protoc-bridge/tree/master/protoc-gen/src/main/scala/protocgen" target="_blank" rel="noopener noreferrer">protocgen</a>. This is the place you would normally start to customize from.  The template starts by parsing the parameters given in the request, then it creates a <code>DescriptorImplicits</code> object that provides us with ScalaPB-specific information about the protobuf entities such as the names of generated Scala types.</p><p>It is important to pass ScalaPB&#x27;s parameters to DescriptorImplicits rather than the default since parameters such as <code>flat_package</code> change the package name and thus the generated code may not compile due to trying to use a symbol that doesn&#x27;t exist.</p><p>The code instantiates a <code>MessagePrinter</code> for each message. We use a class rather than a method here so we only import the implicits in a single place:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">class MessagePrinter(message: Descriptor, implicits: DescriptorImplicits) {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  import implicits._</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val MessageObject =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    message.scalaType.sibling(message.scalaType.name + &quot;FieldNums&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def scalaFileName =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    MessageObject.fullName.replace(&#x27;.&#x27;, &#x27;/&#x27;) + &quot;.scala&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def result: CodeGeneratorResponse.File = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    val b = CodeGeneratorResponse.File.newBuilder()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    b.setName(scalaFileName)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    b.setContent(content)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    b.build()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def printObject(fp: FunctionalPrinter): FunctionalPrinter =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    fp</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      .add(s&quot;object ${MessageObject.name} {&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      .indented(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _.print(message.getFields().asScala){ (fp, fd) =&gt; printField(fp, fd) }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        .add(&quot;&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        .print(message.getNestedTypes().asScala) {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          (fp, m) =&gt; new MessagePrinter(m, implicits).printObject(fp)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      )</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      .add(&quot;}&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def printField(fp: FunctionalPrinter, fd: FieldDescriptor): FunctionalPrinter =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    fp.add(s&quot;val ${fd.getName} = ${fd.getNumber}&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def content: String = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    val fp = new FunctionalPrinter()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .add(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      s&quot;package ${message.getFile.scalaPackage.fullName}&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      &quot;&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ).call(printObject)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    fp.result</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="changing-the-generated-code"></a>Changing the generated code<a class="hash-link" href="#changing-the-generated-code" title="Direct link to heading">#</a></h2><p>Let&#x27;s make a simple change for the generated code. For example, try changing the suffix of the generated classes from <code>FieldNums</code> to <code>FieldNumbers</code>:</p><p>Before:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">private val MessageObject =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  message.scalaType.sibling(message.scalaType.name + &quot;FieldNums&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>After:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">private val MessageObject =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  message.scalaType.sibling(message.scalaType.name + &quot;FieldNumbers&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p> Then run <code>e2eJVM2_12/test</code>. The code in <code>e2e</code> will be regenerated, and you‚Äôll see a compilation error, since the tests still use the old names. You can open the generated code under <code>target/scala_2.12</code> directory to see the modified generated code. To finish this exercise on a positive note, make the tests in <code>e2e/src/test/scala</code> pass by updating the reference to the new class name.
Publishing the code generator</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="adding-custom-options"></a>Adding custom options<a class="hash-link" href="#adding-custom-options" title="Direct link to heading">#</a></h2><p>This section describes how you can let your users customize the generated code
via options. To add custom options, follow this process:</p><ol><li><p>Create a proto file with the custom options you want to add under
<code>core/src/main/protobuf</code>. Name it something like <code>myplugin.proto</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-protobuf codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">syntax = &quot;proto2&quot;;</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">package myorg.myplugin;</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import &quot;google/protobuf/descriptor.proto&quot;;</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">extend google.protobuf.MessageOptions {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      optional MyMessageOptions myopts = 60001;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">message MyMessageOptions {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      optional bool my_option = 1;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>The number 60001 above is just an example!</h5></div><div class="admonition-content"><p>It&#x27;s important that different extensions do not use the same numbers so they do not overwrite
each other&#x27;s data. If you publish your plugin externally, <a href="https://github.com/protocolbuffers/protobuf/blob/master/docs/options.md" target="_blank" rel="noopener noreferrer">request for an
extension number here</a>.</p></div></div></li><li><p>Make your <code>core</code> project generate both Java and Scala sources for the
custom options proto by adding the following settings to the <code>core</code>
project in <code>build.sbt</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">Compile / PB.targets := Seq(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  PB.gens.java -&gt; (Compile / sourceManaged).value / &quot;scalapb&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  scalapb.gen(javaConversions = true) -&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    (Compile / sourceManaged).value / &quot;scalapb&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>The core project will only need the Java version of the new protobuf.
Update its settings as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">libraryDependencies ++= Seq(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   &quot;com.thesamet.scalapb&quot; %% &quot;compilerplugin&quot; % scalapb.compiler.Version.scalapbVersion,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   &quot;com.thesamet.scalapb&quot; %% &quot;scalapb-runtime&quot; % scalapb.compiler.Version.scalapbVersion,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   &quot;com.thesamet.scalapb&quot; %% &quot;scalapb-runtime&quot; % scalapb.compiler.Version.scalapbVersion % &quot;protobuf&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain"> ),</span></div><div class="token-line" style="color:#403f53"><span class="token plain"> Compile / PB.protoSources += core.base / &quot;src&quot; / &quot;main&quot; / &quot;protobuf&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain"> Compile / PB.targets := Seq(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   PB.gens.java -&gt; (Compile / sourceManaged).value / &quot;scalapb&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain"> )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This would tell ScalaPB to compile the protobuf that&#x27;s in the core project protobuf directory. We
are adding <code>scalapb</code> as a <code>&quot;protobuf&quot;</code> dependency so it extracts <code>scalapb.proto</code>, and its own
transitive dependencies which includes <code>google/protobuf/descriptor.proto</code>.</p></li><li><p>Register the extension in the code generator. In your code generator , under <code>code-gen/src/main/scala/</code>
look for the <code>registerExtensions</code> method, and add a call to register your own extension:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">myorg.myplugin.Myplugin.registerAllExtensions(registry)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>Now you are able to extract the extension value in your generator using the standard protobuf-java
APIs:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scsala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">messageDescriptor.getOptions.getExtension(myorg.myplugin.Myplugin.myopts).getMyOption</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li><li><p>You can now use the new option in your e2e tests. Also the newly added proto will be automatically
packaged with the core jar. External projects will be able to unpack it by depending on the core
library with a <code>% &quot;protobuf&quot;</code> scope. To use:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-protobuf codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">import &quot;myplugin.proto&quot;;</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">message MyMessage {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  option (myplugin.myopts).my_option = false;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="publishing-the-plugin"></a>Publishing the plugin<a class="hash-link" href="#publishing-the-plugin" title="Direct link to heading">#</a></h2><p>The project can be published to Maven using the ‚Äúpublish‚Äù command. We recommend to use the excellent <a href="https://github.com/olafurpg/sbt-ci-release" target="_blank" rel="noopener noreferrer">sbt-ci-release</a> plugin to automatically build a snapshot on each commit, and a full release when pushing a git tag.</p><p>SBT users of your code generators will add your plugin to the build by adding it to their <code>project/plugins.sbt</code> like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">Compile / PB.targets := Seq(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  scalapb.gen()      -&gt; (Compile / sourceManaged).value / &quot;scalapb&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  com.myplugin.gen() -&gt; (Compile / sourceManaged).value / &quot;scalapb&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The template also publishes artifacts with names ending with <code>unix.sh</code> and <code>windows.bat</code>. These are executable jars for Unix and Windows systems that contain all the classes needed to run your code generator (except of a JVM which is expected to be in <code>JAVA_HOME</code> or in the <code>PATH</code>). This is useful if your users need to use your plugin directly with protoc, or with a build tool such as maven.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="secondary-outputs"></a>Secondary outputs<a class="hash-link" href="#secondary-outputs" title="Direct link to heading">#</a></h2><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Secondary outputs were introduced in protoc-bridge 0.9.0 and are supported by sbt-protoc 1.0.0 and onwards.</p></div></div><p>Secondary outputs provide a simple way for protoc plugins to pass information for other protoc plugins running after them in the same protoc invocation. The information is passed through files that are created in a temporary directory. The absolute path of that temporary directory is provided to all protoc plugins. Plugins may create new files in that directory for subsequent plugins to consume.</p><p>Conventions:</p><ul><li>Names of secondary output files should be in <code>kebab-case</code>, and should clearly identify the plugin producing them. For example <code>scalapb-validate-preprocessor</code>.</li><li>The content of the file should be a serialized <code>google.protobuf.Any</code> message that packs the arbitrary payload the plugin wants to publish.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="determining-the-secondary-output-directory-location"></a>Determining the secondary output directory location<a class="hash-link" href="#determining-the-secondary-output-directory-location" title="Direct link to heading">#</a></h3><p>JVM-based plugins that are executed in the same JVM that spawns protoc (like the ones described on this page), receive the location of the secondary output directory via the <code>CodeGeneratorRequest</code>. <code>protoc-bridge</code> appends to the request an unknown field carrying a message called <code>ExtraEnv</code> which contains the path to the secondary output directory.</p><p>Other plugins that are invoked directly by protoc can find the secondary output directory by inspecting the <code>SCALAPB_SECONDARY_OUTPUT_DIR</code> environment variable.</p><p><code>protoc-bridge</code> takes care of creating the temporary directory and setting up the environment variable before invoking <code>protoc</code>. If <code>protoc</code> is ran manually (for example, through the CLI), it is the user&#x27;s responsibility to create a directory for secondary outputs and pass it as an environment variable to <code>protoc</code>. It&#x27;s worth noting that ScalaPB only looks for secondary output directory if a preprocessor is requested, and therefore for the most part users do not need to worry about secondary output directories.</p><p>In ScalaPB&#x27;s code base, <a href="https://github.com/scalapb/ScalaPB/blob/75ad2323b8fc35f005c40471fa714a0eca0afd6d/compiler-plugin/src/main/scala/scalapb/compiler/SecondaryOutputProvider.scala#L78-L83" target="_blank" rel="noopener noreferrer">SecondaryOutputProvider</a> provides a method to find the secondary output directory as described above.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="preprocessors"></a>Preprocessors<a class="hash-link" href="#preprocessors" title="Direct link to heading">#</a></h2><p>Preprocessors are protoc plugins that provide <a href="#secondary-outputs">secondary outputs</a> that are consumed by ScalaPB. ScalaPB expects the secondary output to be a <code>google.protobuf.Any</code> that encodes a <a href="https://github.com/scalapb/ScalaPB/blob/75ad2323b8fc35f005c40471fa714a0eca0afd6d/protobuf/scalapb/scalapb.proto#L346-L348" target="_blank" rel="noopener noreferrer">PreprocessorOutput</a>. The message contains a map between proto file names (as given by <code>FileDescriptor#getFullName()</code>) to additional <code>ScalaPbOptions</code> that are merged with the files options. By appending to <code>aux_field_options</code>, a preprocessor can, for example, impact the generated types of ScalaPB fields.</p><ul><li>ScalaPB applies the provided options to a proto file only if the original file lists the preprocessor secondary output filename in a <code>preprocessors</code> file-level option. That option can be inherited from a package-scoped option.</li><li>To exclude a specific file from being preprocessed (if it would be otherwise impacted by a package-scoped option), add a <code>-NAME</code> entry to the list of preprocessors where <code>NAME</code> is the name of the preprocessor&#x27;s secondary output.</li><li>In case of multiple preprocessors, options of later preprocessors overrides the one of earlier processors. Options in the file are merged over the preprocessor&#x27;s options. When merging, repeated fields get concatenated.</li><li>Preprocessor plugins need to be invoked (in <code>PB.targets</code> or protoc&#x27;s command line) before ScalaPB, so when ScalaPB runs their output is available.</li><li>Plugins that depend on ScalaPB (such as scalapb-validate) rely on <code>DescriptorImplicits</code> which consume the preprocessor output and therefore also see the updated options.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>If you followed this guide all the way to here, then congratulations for creating your first protoc plugin in Scala!</p><p>If you have any questions, feel free to reach out to us on Gitter or Github.</p><p>Did you write an interesting protoc plugin? Let us know on our gitter channel or our Google group and we&#x27;d love to mention it here!</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/generic"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Writing generic code</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/upgrading"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Upgrade guide ¬ª</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction-what-is-a-protoc-plugin" class="table-of-contents__link">Introduction: What is a protoc plugin?</a></li><li><a href="#when-to-write-a-protoc-plugin" class="table-of-contents__link">When to write a protoc plugin?</a></li><li><a href="#getting-started" class="table-of-contents__link">Getting Started</a></li><li><a href="#look-around" class="table-of-contents__link">Look around</a></li><li><a href="#running-the-tests" class="table-of-contents__link">Running the tests</a></li><li><a href="#understanding-the-code-generator" class="table-of-contents__link">Understanding the code generator</a></li><li><a href="#changing-the-generated-code" class="table-of-contents__link">Changing the generated code</a></li><li><a href="#adding-custom-options" class="table-of-contents__link">Adding custom options</a></li><li><a href="#publishing-the-plugin" class="table-of-contents__link">Publishing the plugin</a></li><li><a href="#secondary-outputs" class="table-of-contents__link">Secondary outputs</a><ul><li><a href="#determining-the-secondary-output-directory-location" class="table-of-contents__link">Determining the secondary output directory location</a></li></ul></li><li><a href="#preprocessors" class="table-of-contents__link">Preprocessors</a></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/installation">Installation</a></li><li class="footer__item"><a href="https://scalapb.github.io/api/scalapb" target="_blank" rel="noopener noreferrer" class="footer__link-item">ScalaDoc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/scalapb" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://gitter.im/ScalaPB/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a href="https://groups.google.com/g/scalapb" target="_blank" rel="noopener noreferrer" class="footer__link-item">Google Groups</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/scalapb/ScalaPB" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2014-2024, <a href="https://www.linkedin.com/in/nadav-samet/">Nadav Samet</a></div></div></div></footer></div>
<script src="/styles.022ff8f0.js"></script>
<script src="/runtime~main.0526e393.js"></script>
<script src="/main.61b71543.js"></script>
<script src="/1.d1f2961e.js"></script>
<script src="/2.f4df6e70.js"></script>
<script src="/49.50d7d611.js"></script>
<script src="/50.a4265ab1.js"></script>
<script src="/935f2afb.5b2cd0a8.js"></script>
<script src="/17896441.4580ba69.js"></script>
<script src="/30c1f25e.81796517.js"></script>
</body>
</html>